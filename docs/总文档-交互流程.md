# 基金持有列表 - 总文档（交互流程）

## 一、文档说明

本文档描述「基金持有列表」功能的整体交互流程、用户动线及前后端协作关系，与《前端文档》《后端文档》配套使用。

---

## 二、用户动线总览

```
打开小程序 → 无感登录(静默) → 进入首页/持有页
                ↓
        首次：创建用户，下发占位信息
        非首次：直接下发已存用户信息
                ↓
用户进入「持有列表」 → 拉取持有数据 + 拉取行情 → 计算并展示表格（含账户资产、单日总收益；当日收益支持金额/收益率切换）
                ↓
        ├→ 添加持有：选基金、按金额填首次投入 → 提交 → 刷新列表
        ├→ 加仓：选某只、按金额输入 → 前端算份额 → 提交 → 刷新列表
        ├→ 减仓：选某只、按份额输入 → 提交 → 后端按比例扣总投入 → 刷新列表
        └→ 取消持有：整只移除 → 确认 → 刷新列表
```

---

## 三、核心交互流程

### 3.1 打开小程序 → 无感登录

| 步骤 | 端 | 动作 |
|------|----|------|
| 1 | 前端 | 小程序启动/进入时静默调用 `wx.login()`，获得临时 code |
| 2 | 前端 | 将 code 请求 `POST /auth/wx-login` |
| 3 | 后端 | 用 code 调微信 `jscode2session` 换取 openid（及 session_key） |
| 4 | 后端 | 按 openid 查用户：无则创建（生成占位昵称、id），有则直接读 |
| 5 | 后端 | 返回用户信息（占位昵称、占位 id）+ 登录态（如 token） |
| 6 | 前端 | 存储 token 与用户信息，后续请求携带 token；在「我的」等位置展示占位昵称/id |

**说明**：全程无弹窗，用户无感知；昵称、id 仅占位，不需微信授权。

---

### 3.2 查看持有列表

| 步骤 | 端 | 动作 |
|------|----|------|
| 1 | 前端 | 用户进入持有列表页，请求 `GET /user/watchlist`（带 token） |
| 2 | 后端 | 鉴权后按 openid 返回持有列表（fundCode、fundName、**total_principal**、**total_shares**） |
| 3 | 前端 | 根据列表中的 fundCode 拉取基金行情（控制频率：防抖、缓存、按需） |
| 4 | 前端 | 用「持仓数据 + 行情」计算每只的当日收益、持有收益，并汇总单日总收益、账户资产（总持仓金额） |
| 5 | 前端 | 以表格形式渲染：每行一只基金，列包括名称、持仓金额、模拟涨幅、当日收益（可切换金额/收益率）、持有收益；支持列头排序（前端排序） |
| 6 | 前端 | 在列表上方或下方展示「账户资产」（总持仓金额 ≈ 总投入+总收益）、「单日总收益」汇总；当日收益列支持切换展示「具体金额」或「收益率」 |

**数据流**：后端只提供「持有 + 持仓字段」；行情与所有收益计算在前端完成。

---

### 3.3 添加持有（首次、按金额）

| 步骤 | 端 | 动作 |
|------|----|------|
| 1 | 前端 | 用户点击「添加持有」，进入选择/搜索基金（可本地列表或调搜索接口） |
| 2 | 前端 | 用户选择一只基金，**按金额**填写首次投入；前端用当前净值算份额：addShares = addAmount / 当前净值 |
| 3 | 前端 | 提交前校验：该 fundCode 是否已在当前持有列表中（防重复） |
| 4 | 前端 | 请求 `POST /user/watchlist`，body：fundCode、fundName、addAmount、addShares |
| 5 | 后端 | 鉴权 + 重复校验；通过则写入 total_principal=addAmount、total_shares=addShares |
| 6 | 前端 | 成功则返回持有列表页并刷新列表；失败则提示 |

---

### 3.4 加仓（按金额）

| 步骤 | 端 | 动作 |
|------|----|------|
| 1 | 前端 | 用户在持有列表中某只基金上操作「加仓」，输入**加仓金额** |
| 2 | 前端 | 用当前净值折算份额：addShares = addAmount / 当前净值；请求加仓接口，body：addAmount、addShares |
| 3 | 后端 | 鉴权后按 openid + fundCode 找到记录；total_principal += addAmount，total_shares += addShares |
| 4 | 前端 | 成功则刷新该行并重算收益与汇总；失败则提示 |

---

### 3.5 减仓（按份额）

| 步骤 | 端 | 动作 |
|------|----|------|
| 1 | 前端 | 用户在持有列表中某只基金上操作「减仓」，输入**减仓份额**（不超过当前 total_shares） |
| 2 | 前端 | 请求减仓接口，body：reduceShares |
| 3 | 后端 | 鉴权后定位记录；total_shares -= reduceShares；total_principal 按比例扣减：total_principal *= (1 - reduceShares/原total_shares)；若 total_shares 归零可删除该条记录 |
| 4 | 前端 | 成功则刷新列表并重算；失败则提示 |

---

### 3.6 取消持有（整只清仓）

| 步骤 | 端 | 动作 |
|------|----|------|
| 1 | 前端 | 用户在列表中操作「取消持有」某只基金，可二次确认 |
| 2 | 前端 | 请求 `DELETE /user/watchlist/:fundCode`（带 token） |
| 3 | 后端 | 鉴权后删除该用户下该 fundCode 的持有记录 |
| 4 | 前端 | 成功则从列表移除该行并重新计算单日总收益、账户资产；失败则提示 |

---

## 四、页面与入口关系（示意）

```
小程序
├── 首页
├── 持有列表页（表格：每行一只基金，列：名称/持仓/模拟涨幅/当日收益(可切换金额⇄收益率)/持有收益；汇总：账户资产、单日总收益）
│   ├── 入口：添加持有 → 选基金 + 按金额填首次投入 → 提交
│   ├── 行操作：加仓（按金额）、减仓（按份额）、取消持有（整只清仓）
│   └── 列头：排序（前端）
└── 我的（展示占位昵称、id）
```

---

## 五、前后端数据边界

| 数据 | 归属 | 说明 |
|------|------|------|
| 用户身份（openid）、占位昵称/id、登录态 | 后端 | 后端创建/存储，登录接口下发 |
| 持有列表（fundCode、fundName、total_principal、total_shares） | 后端 | 后端增删改查；加仓按金额累加、减仓按份额扣减并按比例扣总投入 |
| 基金行情（净值、涨跌幅等） | 前端 | 前端拉第三方/自有接口，控制频率 |
| 当日收益、持有收益、单日总收益、账户资产（总持仓金额） | 前端 | 前端根据持仓+行情计算，不落库；当日收益支持界面切换为金额或收益率展示 |
| 列表排序结果 | 前端 | 前端内存排序，不传后端 |

---

## 六、异常与边界

- **未登录/ token 失效**：后端返回 401，前端引导重新静默登录（wx.login → 再拿 token）。
- **添加持有重复**：后端返回 4xx 或明确错误码，前端提示「已持有该基金」。
- **网络失败**：前端提示，可保留本地缓存列表，恢复网络后重新拉取并同步。

---

**关联文档**：  
- 《前端文档-实现说明》  
- 《后端文档-实现说明》

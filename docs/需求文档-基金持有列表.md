# 基金持有列表 - 完整需求文档

## 一、项目概述

在基金估值小程序中实现「我的持有」能力：用户无感登录后，可查看持有基金列表（表格形式）、添加/取消持有、修改持仓；收益与排序在前端计算与处理，后端仅负责用户身份与持有数据的存储与下发。

---

## 二、角色与分工

| 角色 | 职责 |
|------|------|
| **前端（小程序）** | 无感登录与用户信息展示；拉取基金行情并控制频率；收益计算（当日收益、持有收益、单日总收益）；持有列表表格展示与排序；添加/取消持有、修改持仓的交互与请求。 |
| **后端** | 静默登录（code → openid）、用户创建与信息下发；持有列表的增删改查及持仓字段的存储与返回；不拉取第三方基金接口，不参与收益计算与排序。 |

---

## 三、功能需求

### 3.1 登录与用户信息

| 项 | 说明 |
|----|------|
| 触发时机 | 用户打开小程序时 |
| 行为 | 无感检测登录状态：前端静默调用 `wx.login()` 获取 code，将 code 发往后端 |
| 后端逻辑 | 用 code 向微信换取 openid；若该 openid 无对应用户则创建用户并初始化；若有则直接使用 |
| 返回内容 | 占位昵称、占位 id 等用户信息及登录态（如 token） |
| 补充 | 昵称、id 仅作占位展示，不需要微信头像/昵称/手机号授权 |

### 3.2 持有列表展示

| 项 | 说明 |
|----|------|
| 展示形式 | **列表/表格**，参考既有设计稿：每**行**一只基金，多列展示；顶部可有返回/关闭与页码（如 1/1） |
| 每行列内容 | 基金名称（名称下可带持仓金额）、持仓金额、模拟涨幅（含日期）、当日收益（含日期，**展示具体数额**，并支持切换为**收益率**展示）、持有收益（含日期、金额与百分比） |
| 汇总 | **账户资产**：总持仓金额（≈ 总投入 + 总收益），在列表上方或下方展示；**单日总收益**：所有持有基金的「当日收益」之和，一并展示 |
| 排序 | 列标题旁可带排序箭头，点击切换排序；**排序完全由前端对当前列表数据处理，后端不提供排序** |
| 数据来源 | 基金行情由前端拉取；当日收益、持有收益、单日总收益由前端根据「后端下发的持仓数据 + 前端拉取的行情」计算 |

### 3.3 持有操作

| 操作 | 说明 |
|------|------|
| **添加持有** | 用户选择某只基金并**按金额**填写首次投入，提交后后端写入持有列表（存总投入金额、总份额）；前端需做重复校验（同一基金不重复持有）。 |
| **加仓** | 对已持有的基金**按金额**加仓：用户输入加仓金额，前端按当前净值折算份额，后端在原有记录上累加总投入金额与总份额。 |
| **减仓** | 对已持有的基金**按份额**减仓：用户输入减仓份额，后端扣减总份额，并按比例扣减总投入金额；若份额归零可删除该条持有记录。 |
| **取消持有** | 用户从列表中移除某只基金（全部卖出/清仓），后端删除该条持有记录。 |

### 3.4 持仓数据模型（后端存储）

为支持「加仓按金额、减仓按份额」，单只基金仅存两条核心字段：

| 字段 | 含义 | 说明 |
|------|------|------|
| **total_principal** | 总投入金额 | 历次加仓的金额累计；减仓时按份额比例扣减对应成本。 |
| **total_shares** | 总持有份额 | 加仓时按「金额÷当时净值」折算份额累加；减仓时直接减去份额。 |

- **持仓金额（市值）** = total_shares × 当前净值，由前端用行情计算展示。  
- **持有收益** = 持仓金额 − total_principal，由前端计算。  
- 后端不存净值、不计算收益，只维护 total_principal 与 total_shares。

---

## 四、数据与计算规则

### 4.1 收益口径

| 名称 | 含义 | 计算方 |
|------|------|--------|
| 单只当日收益 | 该只基金当日收益金额 | 前端根据持仓与当日行情计算；列表需展示**具体数额**，并支持切换为**收益率**展示 |
| 单只持有收益 | 该只基金从买入到当前的累计收益（金额与百分比） | 前端根据持仓与行情计算 |
| 单日总收益 | 所有持有基金的「当日收益」之和 | 前端汇总 |
| 账户资产（总持仓金额） | 总投入 + 总收益 | 前端汇总（所有持有基金的当前持仓/市值之和，或 总投入+总持有收益） |

### 4.2 加仓与减仓规则（与存储一致）

| 操作 | 用户输入 | 前端 | 后端 |
|------|----------|------|------|
| 添加持有 | 金额 | addShares = addAmount / 当前净值，传 addAmount、addShares | 写入 total_principal=addAmount，total_shares=addShares |
| 加仓 | 金额 | addShares = addAmount / 当前净值，传 addAmount、addShares | total_principal += addAmount，total_shares += addShares |
| 减仓 | 份额 | 传 reduceShares，校验 ≤ total_shares | total_shares -= reduceShares；total_principal *= (1 - reduceShares/原total_shares)；份额归零可删记录 |
| 取消持有 | - | 请求删除 | 删除该条持有记录 |

### 4.3 频率与压力

- **后端**：不拉取第三方基金行情接口，避免服务器侧请求频率压力。
- **前端**：负责调用基金行情接口，并自行控制调用频率（防抖、缓存、按需拉取等），用「后端下发的持仓 + 前端拉取的行情」在本地完成所有收益计算与展示。

---

## 五、后端接口清单

| 接口 | 方法 | 说明 |
|------|------|------|
| 静默登录 | `POST /auth/wx-login` | 入参：`code`。后端用 code 换 openid，无则创建用户；返回占位昵称、占位 id、登录态（如 token）。 |
| 持有列表 | `GET /user/watchlist` | 返回当前用户的持有列表，每条含：fundCode、fundName、**total_principal**、**total_shares**；不含行情，不计算收益。 |
| 添加持有 | `POST /user/watchlist` | 入参：fundCode、fundName、**addAmount**（金额）、**addShares**（由前端按金额÷当前净值计算）。后端校验不重复后写入，即 total_principal=addAmount、total_shares=addShares。 |
| 加仓 | `PUT /user/watchlist/:fundCode/add` 或约定用 PATCH | 入参：**addAmount**、**addShares**（前端按金额÷当前净值算）。后端：total_principal += addAmount，total_shares += addShares。 |
| 减仓 | `PUT /user/watchlist/:fundCode/reduce` 或约定用 PATCH | 入参：**reduceShares**（份额）。后端：total_shares -= reduceShares；total_principal 按比例扣减（见后端文档）；若 total_shares 归零可删除记录。 |
| 取消持有 | `DELETE /user/watchlist/:fundCode` | 从持有列表中移除该基金（整只清仓）。 |

**可选**：若添加持有时需搜索基金，可增加 `GET /fund/search?keyword=xxx`（或由前端使用现有数据源/本地列表）。

---

## 六、前端职责汇总（与存储、加减仓一致）

- 无感登录：调用 `wx.login`，将 code 发往后端，保存登录态与用户占位信息。
- 行情拉取：按策略请求基金行情接口，控制频率。
- **持仓与收益计算**：后端只下发 total_principal、total_shares；前端用「total_shares × 当前净值」得到持仓金额，用「持仓金额 − total_principal」得到持有收益；当日收益、单日总收益、账户资产均由前端计算。
- 列表展示：以**表格/列表**形式展示，每行一只基金，列包括基金名称、持仓金额、模拟涨幅、当日收益（具体数额，可切换为收益率）、持有收益；汇总区展示**账户资产**与**单日总收益**；列标题支持排序（前端排序）。
- 持有操作：**添加持有**（按金额，传 addAmount、addShares）、**加仓**（按金额）、**减仓**（按份额）、**取消持有**时调用上述后端接口，并处理重复校验与交互反馈。

---

## 七、非功能与边界

- **重复持有**：同一 fundCode 在同一用户下仅允许一条持有记录，添加时需校验。
- **登录态**：后续持有相关接口需携带登录态（如 token），后端按 openid 鉴权。
- **异常**：网络失败、接口错误时前端需有提示；可考虑本地缓存持有列表，恢复网络后同步。

---

## 八、术语与界面用语

| 概念 | 用语 |
|------|------|
| 列表名称 | 持有列表 / 我的持有 |
| 加入列表 | 添加持有 |
| 从列表移除 | 取消持有 |
| 展示形式 | 列表/表格，每行一只基金（非卡片） |

---

**文档版本**：基于前期沟通整理  
**适用项目**：fund-valuation-mini（基金估值小程序）  
**后端项目**：fund-holding-back-end（或同架构 Node 后端）

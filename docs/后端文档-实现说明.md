# 基金持有列表 - 后端文档（实现说明）

## 一、文档说明

本文档描述后端（如 fund-holding-back-end 或同架构 Node 服务）在「基金持有列表」功能中需要实现的接口、鉴权与数据存储。交互流程见《总文档-交互流程》。

---

## 二、职责总览

- 静默登录：用微信 code 换 openid，创建或查询用户，下发占位昵称、占位 id 及登录态。  
- 持有列表的增删改查：按用户（openid）维度的持有记录；**存储总投入金额（total_principal）与总份额（total_shares）**，以支持「加仓按金额、减仓按份额」。  
- **不做**：不拉取第三方基金行情；不计算收益；不提供列表排序。  

---

## 三、接口清单与规范

### 3.1 静默登录

| 项 | 说明 |
|----|------|
| 路径 | `POST /auth/wx-login` |
| 请求体 | `{ "code": "微信 wx.login 返回的临时 code" }` |
| 后端逻辑 | 1）用 code + AppID + AppSecret 请求微信 `GET https://api.weixin.qq.com/sns/jscode2session`；2）拿到 openid（及 session_key）；3）按 openid 查用户表，无则插入（可生成占位昵称、占位 id），有则直接读；4）生成登录态（如 JWT token，payload 含 openid）；5）返回用户信息 + token |
| 响应示例 | `{ "token": "xxx", "user": { "nickname": "用户xxx", "id": "占位id" } }`（字段名可与前端约定） |
| 错误 | code 无效或微信接口失败返回 4xx，并给出明确错误信息 |

**注意**：AppSecret 仅存后端环境变量，不可下发给前端。

---

### 3.2 持有列表

| 项 | 说明 |
|----|------|
| 路径 | `GET /user/watchlist` |
| 鉴权 | 请求头携带 token（如 `Authorization: Bearer xxx`），校验通过后取 openid |
| 逻辑 | 按 openid 查询该用户的持有记录，返回列表 |
| 响应 | 数组，每条含 `fundCode`、`fundName`、**`total_principal`**（总投入金额）、**`total_shares`**（总持有份额）；不包含行情，不计算收益 |
| 未登录/ token 无效 | 返回 401 |

---

### 3.3 添加持有（首次、按金额）

| 项 | 说明 |
|----|------|
| 路径 | `POST /user/watchlist` |
| 鉴权 | 同上，需 token |
| 请求体 | `{ "fundCode": "xxx", "fundName": "xxx", "addAmount": 10000, "addShares": 9523.81 }`（addShares 由前端按 addAmount÷当前净值计算） |
| 逻辑 | 1）校验同一用户下是否已存在该 fundCode；2）若已存在返回 4xx；3）若不存在则插入一条：total_principal=addAmount，total_shares=addShares |
| 响应 | 成功返回 201 及新记录，或 200 + 当前完整持有列表 |
| 重复 | 同一用户下同一 fundCode 仅允许一条，重复时返回 409 或 400，如「已持有该基金」 |

---

### 3.4 加仓（按金额）

| 项 | 说明 |
|----|------|
| 路径 | `PUT /user/watchlist/:fundCode/add` 或 `PATCH /user/watchlist/:fundCode`（body 含操作类型与参数，与前端约定） |
| 鉴权 | 同上，需 token |
| 请求体 | `{ "addAmount": 5000, "addShares": 4761.90 }`（addShares 由前端按 addAmount÷当前净值计算） |
| 逻辑 | 按 openid + fundCode 定位记录；**total_principal += addAmount**；**total_shares += addShares** |
| 响应 | 200 + 更新后的该条记录或完整列表 |
| 记录不存在 | 返回 404 |

---

### 3.5 减仓（按份额）

| 项 | 说明 |
|----|------|
| 路径 | `PUT /user/watchlist/:fundCode/reduce` 或 `PATCH /user/watchlist/:fundCode`（body 含 reduceShares） |
| 鉴权 | 同上，需 token |
| 请求体 | `{ "reduceShares": 1000 }` |
| 逻辑 | 按 openid + fundCode 定位记录；校验 reduceShares ≤ total_shares；**total_shares -= reduceShares**；**total_principal 按比例扣减**：`total_principal = total_principal * (1 - reduceShares / 原total_shares)` 或等价 `total_principal *= (total_shares_new / total_shares_old)`；若 **total_shares 归零** 可删除该条记录（或保留为 0，与业务约定） |
| 响应 | 200 + 更新后的该条记录（或已删除则返回 204/200）；若已删则列表接口不再返回该条 |
| 记录不存在 / 份额不足 | 返回 404 或 400 |

---

### 3.6 取消持有（整只清仓）

| 项 | 说明 |
|----|------|
| 路径 | `DELETE /user/watchlist/:fundCode` |
| 鉴权 | 同上，需 token |
| 逻辑 | 按 openid + fundCode 删除对应持有记录 |
| 响应 | 成功 200 或 204；若记录不存在可返回 404 或 200（幂等） |

---

## 四、鉴权约定

- 除 `POST /auth/wx-login` 外，上述接口均需验证登录态。  
- 从 token 中解析出 openid，作为「当前用户」标识；所有持有数据的读写均按 openid 隔离。  
- token 无效或过期返回 401，Body 或 Header 可带 `WWW-Authenticate` 或统一错误结构，便于前端统一处理。

---

## 五、数据存储建议

### 5.1 用户表（示例）

| 字段 | 类型 | 说明 |
|------|------|------|
| openid | string, 唯一 | 微信 openid |
| nickname | string | 占位昵称 |
| placeholder_id | string | 占位 id（可自增或随机） |
| created_at | datetime | 创建时间 |
| updated_at | datetime | 更新时间 |

### 5.2 持有表（示例）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | bigint, PK | 主键 |
| openid | string | 对应用户 |
| fund_code | string | 基金代码 |
| fund_name | string | 基金名称 |
| **total_principal** | decimal | **总投入金额**：历次加仓金额累计，减仓时按份额比例扣减 |
| **total_shares** | decimal | **总持有份额**：加仓时按「金额÷净值」折算份额累加，减仓时直接减去份额 |
| created_at | datetime | 添加时间 |
| updated_at | datetime | 更新时间 |

- 唯一约束：`(openid, fund_code)`，同一用户下同一基金仅一条。  
- 持仓金额、持有收益由前端用 total_shares × 当前净值 与 total_principal 计算，后端不存、不算。

---

## 六、错误码与返回格式建议

- 401：未登录或 token 无效。  
- 404：记录不存在（如修改/删除时 fundCode 不存在）。  
- 409 或 400：添加持有时重复，文案如「已持有该基金」。  
- 统一响应格式示例：`{ "ec": 200, "em": "ok", "data": { ... } }`，失败时 `ec` 非 200，`em` 为提示文案。

---

## 七、可选接口

- **基金搜索**：若添加持有时由后端提供搜索，可增加 `GET /fund/search?keyword=xxx`，返回匹配的基金列表（如 fundCode、fundName）。是否拉第三方、是否缓存由后端自行设计；若前端用本地列表或别的数据源则可不实现。

---

## 八、安全与规范

- 所有持有相关接口必须校验 token 并限定在当前 openid 下操作，禁止越权访问他人数据。  
- AppSecret、数据库账号等敏感信息仅存服务端环境变量或配置中心。  
- 入参做合法性校验（如 fundCode 非空、principal ≥ 0），非法请求返回 400 及明确原因。

---

**关联文档**：《总文档-交互流程》《前端文档-实现说明》

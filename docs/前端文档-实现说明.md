# 基金持有列表 - 前端文档（实现说明）

## 一、文档说明

本文档描述小程序端（fund-valuation-mini）在「基金持有列表」功能中需要实现的所有逻辑、界面与对接约定。交互流程见《总文档-交互流程》。

---

## 二、职责总览

- 无感登录与用户信息展示  
- 拉取基金行情并控制频率  
- 收益计算（当日收益、持有收益、单日总收益）  
- 持有列表表格展示与排序  
- 添加持有、取消持有、修改持仓的交互与接口调用  

---

## 三、登录与用户信息

### 3.1 无感登录

| 项 | 实现要点 |
|----|----------|
| 触发 | 小程序启动（如 `App.onLaunch`）或进入需登录态页面时 |
| 步骤 | 1）调用 `wx.login()` 取 code；2）请求 `POST /auth/wx-login`，body: `{ code }`；3）将返回的 token、用户信息（占位昵称、占位 id）写入本地存储（如 `wx.setStorageSync`） |
| 请求头 | 登录接口可不带 token；后续持有相关接口需在 header 中携带 token（如 `Authorization: Bearer xxx`） |
| 失败 | 可重试一次 wx.login；仍失败则提示「网络异常，请稍后重试」 |

### 3.2 用户信息展示

- 在「我的」等页展示后端下发的占位昵称、占位 id，无需再调微信头像/昵称授权。  
- 若本地无 token 或接口返回 401，先执行无感登录再继续业务请求。

---

## 四、持有列表页

### 4.1 数据获取

| 数据 | 来源 | 说明 |
|------|------|------|
| 持有列表（持仓） | `GET /user/watchlist` | 带 token；返回 fundCode、fundName、**total_principal**、**total_shares** |
| 行情 | 自有/第三方基金接口 | 根据列表中的 fundCode 按需拉取；需控制频率（防抖、缓存、合并请求等） |

### 4.2 展示形式

- **布局**：列表/表格，每**行**一只基金（参考既有设计稿，非卡片）。  
- **列**：基金名称（下可带持仓金额）、持仓金额、模拟涨幅（含日期）、当日收益（含日期）、持有收益（含日期、金额与百分比）。  
- **当日收益列**：默认展示**具体金额**；需支持用户切换为**收益率**展示（如点击列标题或切换按钮在「金额 ⇄ 收益率」间切换）。  
- **汇总**：在列表上方或下方展示：  
  - **账户资产**：总持仓金额（概念上 ≈ 总投入 + 总收益），由前端根据所有持有基金的当前市值/持仓金额汇总计算；  
  - **单日总收益**：所有持有基金的当日收益之和。  
- **分页**：若设计稿有页码（如 1/1），按前端分页或滚动加载实现。

### 4.3 当日收益：金额 / 收益率切换

- 当日收益列需展示**具体数额**（如 +1615.43）。  
- 支持用户切换为**收益率**展示（如 +6.58%）：通过列标题点击、或单独切换按钮，在「金额 ⇄ 收益率」两种展示方式间切换；切换状态可保存在前端（如本地状态或 storage），仅影响展示，不请求后端。

### 4.4 排序

- 列标题提供排序入口（如箭头），点击切换升序/降序/默认。  
- 排序在前端对当前列表数据排序，不请求后端，不传排序参数。

---

## 五、收益计算（前端）

### 5.1 口径与公式（示意）

| 名称 | 含义 | 计算方式（由前端实现） |
|------|------|------------------------|
| 持仓金额（市值） | 该只基金当前市值 | **total_shares × 当前净值**（后端只下发了 total_shares，净值来自行情） |
| 单只当日收益 | 该只基金当日收益金额 | 根据 total_shares 与当日涨跌幅计算（如 持仓金额 × 当日涨跌幅%，具体公式依业务规则） |
| 单只当日收益率 | 该只基金当日收益占持仓的比例 | 当日收益金额 ÷ 持仓金额（或成本）× 100%，用于「当日收益」列切换为收益率时的展示 |
| 单只持有收益 | 该只累计收益金额与收益率 | **持仓金额 − total_principal**，其中 持仓金额 = total_shares × 当前净值 |
| 单日总收益 | 所有持有基金的当日收益之和 | 对列表中每只的「当日收益」求和 |
| 账户资产（总持仓金额） | 总投入 + 总收益 | 对所有持有基金的「total_shares × 当前净值」求和 |

### 5.2 注意点

- 依赖「持仓数据」（后端）与「行情数据」（前端拉取），缺一时可展示占位或「计算中」。  
- 行情拉取需控制频率，避免短时间内重复请求同一基金。

---

## 六、持有操作（加仓按金额、减仓按份额）

### 6.1 添加持有（首次、按金额）

| 项 | 实现要点 |
|----|----------|
| 入口 | 持有列表页「添加持有」按钮 |
| 选基金 | 本地列表选择或搜索（若后端提供 `GET /fund/search` 则调用）；需得到 fundCode、fundName |
| 填表单 | 用户**按金额**输入首次投入；前端用**当前净值**折算份额：addShares = addAmount / currentNav（小数位数按业务规则） |
| 提交前 | 校验当前持有列表中是否已有该 fundCode，若有则提示「已持有该基金」 |
| 请求 | `POST /user/watchlist`，body: `{ fundCode, fundName, addAmount, addShares }` |
| 成功后 | 返回列表页并重新拉取持有列表；重新拉行情并计算收益、账户资产 |

### 6.2 加仓（按金额）

| 项 | 实现要点 |
|----|----------|
| 入口 | 列表中某行的「加仓」操作（弹窗或抽屉） |
| 输入 | 用户输入**加仓金额**；前端用当前净值算份额：addShares = addAmount / currentNav |
| 请求 | 加仓接口（如 `PUT /user/watchlist/:fundCode/add` 或 PATCH），body: `{ addAmount, addShares }` |
| 成功后 | 刷新该行数据，重新计算该只的持仓金额、当日收益、持有收益及列表汇总（单日总收益、账户资产） |

### 6.3 减仓（按份额）

| 项 | 实现要点 |
|----|----------|
| 入口 | 列表中某行的「减仓」操作（弹窗或抽屉） |
| 输入 | 用户输入**减仓份额**；前端校验 ≤ 当前 total_shares，可展示当前可减仓份额上限 |
| 请求 | 减仓接口（如 `PUT /user/watchlist/:fundCode/reduce` 或 PATCH），body: `{ reduceShares }` |
| 成功后 | 若后端删除该条（份额归零），则从列表移除该行；否则刷新该行；重新计算单日总收益、账户资产 |

### 6.4 取消持有（整只清仓）

| 项 | 实现要点 |
|----|----------|
| 入口 | 列表中每行的「取消持有」等操作 |
| 确认 | 建议二次确认弹窗 |
| 请求 | `DELETE /user/watchlist/:fundCode` |
| 成功后 | 从列表中移除该行，重新计算单日总收益、账户资产；可选再请求一次列表以保持与后端一致 |

---

## 七、接口对接约定（前端视角）

| 接口 | 方法 | 前端需传 | 前端处理返回 |
|------|------|----------|--------------|
| 静默登录 | POST /auth/wx-login | body: { code } | 存 token、昵称、id；失败提示或重试 |
| 持有列表 | GET /user/watchlist | Header: Authorization | 解析 total_principal、total_shares，再拉行情；持仓金额=份额×净值，持有收益=持仓金额−总投入 |
| 添加持有 | POST /user/watchlist | body: fundCode, fundName, addAmount, addShares | 成功刷新列表；失败根据错误码提示 |
| 加仓 | PUT/PATCH /user/watchlist/:fundCode/add | body: addAmount, addShares | 成功刷新该行并重算汇总 |
| 减仓 | PUT/PATCH /user/watchlist/:fundCode/reduce | body: reduceShares | 成功移除该行或刷新该行并重算汇总 |
| 取消持有 | DELETE /user/watchlist/:fundCode | - | 成功移除该行并重算账户资产、单日总收益 |

- 除登录外，所有请求需带登录态（如 `Authorization`）。  
- 401：清除本地 token，触发静默登录后重试或提示重新进入。

---

## 八、异常与体验

- **网络失败**：toast 提示，可保留上次列表缓存，恢复网络后重新请求列表。  
- **重复添加**：提交前前端校验 + 后端可能再次返回错误，统一提示「已持有该基金」。  
- **行情缺失**：某只基金暂时无行情时，当日收益/持有收益可显示「-」或「计算中」，不阻塞列表展示。

---

## 九、术语与界面用语

- 列表名称：持有列表 / 我的持有  
- 加入：添加持有（按金额）  
- 加仓：按金额；减仓：按份额  
- 移除：取消持有（整只清仓）  
- 展示：列表/表格，每行一只基金；持仓金额 = total_shares × 当前净值  

---

**关联文档**：《总文档-交互流程》《后端文档-实现说明》
